# chuck-stack-nix

The purpose of this repository is to provide nixos configuration files to quickly assemble a working chuck-stack.

For more information, go to the [chuck-stack](https://chuck-stack.org).

## Nix Configurations

You can use the below files like a menu of services. Chose the options you wish to install on a given server using the below instructions.

- system.nix - installs all the tools one might expect to manage a server.
- postgresql.nix - installs PostgreSQL with minimal configuration
- user.nix - provides example 'real' and 'system' users
- stk-todo-app-install.nix - represents the most simple version of a chuck-stack application
  - configures PostgreSQL to contain a specific database
  - creates a service to run migrations
  - creates a PostgREST user named: postgrest
  - configures PostgREST and runs it as a service
- nginx.nix - installs and configures nginx for publishing a static and providing a reverse proxy for PostgREST

## First Connection

This section assumes you are connecting to a new NixOS instance. The below bash code snippet does the following:

1. install the tools to make your first changes to /etc/nixos/configuration.nix
1. clones this repository in /etc/nixos/chuck-stack-nix/
1. updates configuration.nix to include the appropriate nix configuration files
1. exits out of the nix-shell so that when you nixos-rebuild, you get the latest tools.

Note: since a new instance of NixOS has few tools installed by default, you can use nix-shell to temporarily install git, neovim and tmux (and anything else you wish to use temporarily).

```bash
tmux # create a session that remains even if you get disconnected
nix-shell --packages git neovim tmux
cd /etc/nixos/
git clone https://github.com/chuckstack/chuck-stack-nix.git
nvim configuration.nix #make below changes
exit # exit nix-shell
```
## Configuration.nix

Here is an example configuration.nix file. Notice that I added the lines ending in '# here'. 

```nix
...
  imports = [
    # Include the default incus configuration.
    "${modulesPath}/virtualisation/incus-virtual-machine.nix"
    # Include the container-specific autogenerated configuration.
    ./incus.nix
    ./chuck-stack-nix/system.nix  # here
    ./chuck-stack-nix/postgresql.nix  # here
    ./chuck-stack-nix/user.nix  # here
    ./chuck-stack-nix/stk-todo-app-install.nix  # here
    ./chuck-stack-nix/nginx.nix  # here
    ];
...
```

To rebuild with the new configuration:
```
nixos-rebuild switch
```
If you exit from tmux and the nixos session then reconnect, your bash session will be updated with all the new tools and features.

##  stk-todo-app-install.nix

Assuming no errors were thrown, you now have a working todo application.

To list the existing todos via PostgREST:

```bash
curl localhost:3000/todo
```

To add a new todo via PostgREST:

```bash
curl http://localhost:3000/todo -X POST -H "Content-Type: application/json" -d '{"task": "work on nginx"}'
```
