# chuck-stack-nix

The purpose of this repository is to provide nixos configuration files to quickly assemble a working chuck-stack.

For more information, go to the [chuck-stack](https://chuck-stack.org).

## Nix Configurations

You can use the below files like a menu of services. Chose the options you wish to install on a given server using the below instructions.

- system.nix - installs all the tools one might expect to manage a server.
- postgresql.nix - installs PostgreSQL with minimal configuration
- user.nix - provides example 'real' and 'system' users
- stk-app.nix - represents the most simple version of a chuck-stack application
  - configures PostgreSQL to contain a specific database
  - creates a service to run [migrations](https://github.com/chuckstack/stk-todo-app-sql)
  - creates a PostgREST user named: postgrest
  - configures PostgREST and runs it as a service
- nginx.nix - installs and configures nginx for publishing a static and providing a reverse proxy for PostgREST
- [more...](./nixos/)

## First Connection

This section assumes you are connecting to a new NixOS instance. The below bash code snippet does the following:

1. install the tools to make your first changes to /etc/nixos/configuration.nix
1. clones this repository in /etc/nixos/chuck-stack-nix/
1. updates configuration.nix to include the appropriate nix configuration files
1. exits out of the nix-shell so that when you nixos-rebuild, you get the latest tools.

Note: since a new instance of NixOS has few tools installed by default, you can use nix-shell to temporarily install git, neovim and tmux (and anything else you wish to use temporarily).

```bash
tmux # create a session that remains even if you get disconnected
nix-shell --packages git neovim tmux
cd /etc/nixos/
git clone https://github.com/chuckstack/chuck-stack-nix.git
nvim configuration.nix #make below changes
exit # exit nix-shell
```
## Configuration.nix

Here is an example configuration.nix file. Notice that I added the lines ending in '# here'. 

```nix
...
  imports = [
    # Include the default incus configuration.
    "${modulesPath}/virtualisation/incus-virtual-machine.nix"
    # Include the container-specific autogenerated configuration.
    ./incus.nix
    ./chuck-stack-nix/nixos/system.nix  # here
    ./chuck-stack-nix/nixos/postgresql.nix  # here
    ./chuck-stack-nix/nixos/user.nix  # here
    ./chuck-stack-nix/nixos/stk-app.nix  # here
    ./chuck-stack-nix/nixos/nginx.nix  # here
    ./chuck-stack-nix/nixos/nginx-fail2ban.nix  # here
    ];
...
```

To rebuild with the new configuration:
```
nixos-rebuild switch
```
If you exit from tmux and the nixos session then reconnect, your bash session will be updated with all the new tools and features.

### SSH Details

SSH is disabled by default in system.nix. Uncomment the system.nix => services.openssh section if you wish to enable it. The reasons it is disabled by default are:

- It is safer to assume you do not want it enabled and open.
- The NixOS default behavior is to open the ssh port firewall port when the ssh service is enagbled. To prevent this, you must explicitly disable the port in the system.nix => networking.firewall section.
- The Incus command `incus exec instance-name bash` does not use ssh to connect; therefore, you can connect from Incus without needing the sshd services enabled.

### Network Static IP

If you wish to expose an instance to the outside world fron an Incus cluster, execute the following assuming your external IP is x.x.x.x/32.

```bash
# from incus cli
incus config device override incus-isntance-name eth0 ipv4.routes.external=x.x.x.x/32
```

Inside your container's /etc/nixos/configuration.nix, update the systemd.network => networks => networkConfig accordingly:
```nix
...
      networkConfig = {
        Address = "x.x.x.x/32";
        DHCP = "yes";
        IPv6AcceptRA = true;
      };
...
```
If you run `ip a`, you should see an internal IP and the above x.x.x.x/32 external IP.

##  Notes

Each Nix file has a section at the top for notes about the configuration and its usage
